<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Solicita√ß√µes Recebidas</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="grey lighten-4">

  <nav class="blue darken-2">
    <div class="nav-wrapper container">
      <a class="brand-logo"><i class="material-icons left">people</i> Solicita√ß√µes Recebidas</a>
      <ul class="right">
        <li><button id="btn-logout" class="btn red lighten-1"><i class="material-icons left">exit_to_app</i> Sair</button></li>
      </ul>
    </div>
  </nav>

  <main class="container section">
    <h5 class="blue-text text-darken-2">üì• Minhas Caronas e Solicita√ß√µes</h5>
    <div id="solicitacoes-container" class="section">
      <!-- Preenchido via JavaScript -->
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Script -->
  <script>
    const db = firebase.firestore();
    let currentUser = null;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        carregarSolicitacoes();
      } else {
        window.location.href = "login.html";
      }
    });

    document.getElementById("btn-logout").addEventListener("click", () => {
      firebase.auth().signOut().then(() => window.location.href = "login.html");
    });

    function carregarSolicitacoes() {
      const container = document.getElementById("solicitacoes-container");
      container.innerHTML = "";

      db.collection("caronas").where("uid", "==", currentUser.uid)
        .onSnapshot(snapshot => {
          snapshot.forEach(doc => {
            const carona = doc.data();
            const solicitacoes = carona.solicitacoes || [];

            if (solicitacoes.length === 0) return;

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <div class="card-content">
                <span class="card-title"><strong>${carona.escola}</strong></span>
                <p><strong>Origem:</strong> ${carona.origem}</p>
                <p><strong>Destino:</strong> ${carona.destino}</p>
                <p><strong>Vagas dispon√≠veis:</strong> ${carona.vagasDisponiveis}</p>
                <ul class="collection">
                  ${solicitacoes.map((s, index) => `
                    <li class="collection-item">
                      Passageiro UID: ${s.uid} - <strong>Status:</strong> ${s.status}
                      ${s.status === "pendente" ? `
                        <div class="right">
                          <button class="btn-small green" onclick="aprovarSolicitacao('${doc.id}', '${s.uid}')">Aprovar</button>
                          <button class="btn-small red" onclick="rejeitarSolicitacao('${doc.id}', '${s.uid}')">Rejeitar</button>
                        </div>
                      ` : ''}
                    </li>
                  `).join("")}
                </ul>
              </div>
            `;
            container.appendChild(card);
          });
        });
    }

    function aprovarSolicitacao(caronaId, passageiroUid) {
      const ref = db.collection("caronas").doc(caronaId);
      ref.get().then(doc => {
        const data = doc.data();
        const solicitacoes = data.solicitacoes || [];
        const index = solicitacoes.findIndex(s => s.uid === passageiroUid);
        if (index === -1) return;

        // Atualiza o status
        solicitacoes[index].status = "aprovada";

        // Atualiza vagas dispon√≠veis
        const novasVagas = data.vagasDisponiveis > 0 ? data.vagasDisponiveis - 1 : 0;

        ref.update({
          solicitacoes,
          vagasDisponiveis: novasVagas
        }).then(() => {
          alert("Solicita√ß√£o aprovada!");
        });
      });
    }

    function rejeitarSolicitacao(caronaId, passageiroUid) {
      const ref = db.collection("caronas").doc(caronaId);
      ref.get().then(doc => {
        const data = doc.data();
        const solicitacoes = data.solicitacoes || [];
        const index = solicitacoes.findIndex(s => s.uid === passageiroUid);
        if (index === -1) return;

        // Atualiza o status
        solicitacoes[index].status = "rejeitada";

        ref.update({ solicitacoes }).then(() => {
          alert("Solicita√ß√£o rejeitada.");
        });
      });
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
