<!-- solicitacoes.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SolicitaÃ§Ãµes de Carona</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
</head>
<body class="grey lighten-4">

  <nav class="blue darken-2">
    <div class="nav-wrapper container">
      <a href="painel-motorista.html" class="brand-logo">ğŸ”„ SolicitaÃ§Ãµes</a>
      <ul class="right">
        <li><button id="btn-logout" class="btn red">Sair</button></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <h5 id="carona-info" class="blue-text text-darken-2">Carregando carona...</h5>
    <ul id="lista-solicitacoes" class="collection z-depth-1"></ul>
  </main>

  <script src="firebase-config.js"></script>
  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const caronaId = urlParams.get("carona");

    firebase.auth().onAuthStateChanged(user => {
      if (!user) return (window.location.href = "login.html");

      if (!caronaId) return alert("Carona nÃ£o encontrada.");

      const caronaRef = db.collection("caronas").doc(caronaId);

      caronaRef.onSnapshot(doc => {
        const data = doc.data();
        if (!data) return alert("Carona nÃ£o existe mais.");

        document.getElementById("carona-info").innerText = `ğŸšŒ ${data.escola} - ${data.origem} â†’ ${data.destino} | ${data.vagasDisponiveis} vagas`;

        const lista = document.getElementById("lista-solicitacoes");
        lista.innerHTML = "";

        (data.solicitacoes || []).forEach((sol, index) => {
          const li = document.createElement("li");
          li.className = "collection-item";
          li.innerHTML = `
            <strong>${sol.nome}</strong> - ${sol.pontoEncontro || "sem ponto definido"}
            <br>Status: <span class="${statusCor(sol.status)}">${sol.status}</span>
            ${sol.status === "pendente" ? `
              <div class="right">
                <button class="btn green btn-small" onclick="responderSolicitacao('${caronaId}', ${index}, 'aceita')">Aceitar</button>
                <button class="btn red btn-small" onclick="responderSolicitacao('${caronaId}', ${index}, 'recusada')">Recusar</button>
              </div>` : ""}
          `;
          lista.appendChild(li);
        });

        // Se todas as vagas forem ocupadas
        if (data.vagasDisponiveis <= 0 && data.status === "ativa") {
          caronaRef.update({ status: "encerrada" });
        }
      });
    });

    function statusCor(status) {
      switch (status) {
        case "aceita": return "green-text";
        case "recusada": return "red-text";
        default: return "orange-text";
      }
    }

    function responderSolicitacao(caronaId, index, status) {
      const caronaRef = db.collection("caronas").doc(caronaId);

      return db.runTransaction(async transaction => {
        const doc = await transaction.get(caronaRef);
        const data = doc.data();

        if (!data || !data.solicitacoes) return;

        if (data.solicitacoes[index].status !== "pendente") return;

        data.solicitacoes[index].status = status;

        if (status === "aceita") {
          data.vagasDisponiveis = (data.vagasDisponiveis || data.vagas) - 1;
        }

        transaction.update(caronaRef, {
          solicitacoes: data.solicitacoes,
          vagasDisponiveis: data.vagasDisponiveis,
          status: data.vagasDisponiveis <= 0 ? "encerrada" : data.status
        });
      });
    }

    document.getElementById("btn-logout").addEventListener("click", () => {
      firebase.auth().signOut().then(() => {
        window.location.href = "login.html";
      });
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>

