<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Caronas DisponÃ­veis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <style>
    #map { height: 500px; width: 100%; margin-top: 15px; }
    .card-action button { margin-right: 10px; }
  </style>
</head>
<body class="grey lighten-4">

  <nav class="blue darken-2">
    <div class="nav-wrapper container">
      <a href="#!" class="brand-logo">ğŸ—ºï¸ Caronas DisponÃ­veis</a>
      <ul class="right">
        <li><button id="btn-logout" class="btn red">Sair</button></li>
      </ul>
    </div>
  </nav>

  <main class="container section">
    <div class="row">
      <div class="col s12">
        <div id="map"></div>
      </div>
    </div>
  </main>

  <script src="firebase-config.js"></script>
  <script>
    let map;
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (!user) return (window.location.href = "login.html");

      initMap();

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -23.55052, lng: -46.633308 },
          zoom: 12
        });

        db.collection("caronas")
          .where("ativa", "==", true)
          .where("vagas", ">", 0)
          .onSnapshot(snapshot => {
            snapshot.forEach(doc => {
              const data = doc.data();
              const origemCoords = parseLatLng(data.origem);

              const marker = new google.maps.Marker({
                position: origemCoords,
                map: map,
                title: `Carona para ${data.escola}`,
              });

              const info = new google.maps.InfoWindow({
                content: `
                  <div>
                    <strong>ğŸšŒ Escola:</strong> ${data.escola}<br>
                    <strong>ğŸš˜ Origem:</strong> ${data.origem}<br>
                    <strong>ğŸ‘¤ Motorista:</strong> ${data.nomeMotorista || 'Motorista'}<br>
                    <strong>ğŸª‘ Vagas:</strong> ${data.vagas}<br><br>
                    <button class="btn blue btn-small" onclick="solicitarCarona('${doc.id}')">Pedir carona</button>
                  </div>
                `
              });

              marker.addListener("click", () => info.open(map, marker));
            });
          });
      }

      // Parse coordenadas "lat, lng"
      function parseLatLng(str) {
        const [lat, lng] = str.split(',').map(Number);
        return { lat, lng };
      }

      // SolicitaÃ§Ã£o de carona
      window.solicitarCarona = (idCarona) => {
        const ponto = prompt("ğŸ“ Informe seu ponto de encontro:");
        if (!ponto) return;

        db.collection("caronas").doc(idCarona).get().then(doc => {
          const dados = doc.data();
          const solicitacoes = dados.solicitacoes || [];

          // Verifica se jÃ¡ solicitou
          const jaSolicitou = solicitacoes.some(s => s.uid === auth.currentUser.uid);
          if (jaSolicitou) return alert("VocÃª jÃ¡ solicitou esta carona.");

          solicitacoes.push({
            uid: auth.currentUser.uid,
            nome: auth.currentUser.displayName,
            pontoEncontro: ponto,
            status: "pendente"
          });

          db.collection("caronas").doc(idCarona).update({
            solicitacoes: solicitacoes
          }).then(() => {
            M.toast({ html: "ğŸš˜ SolicitaÃ§Ã£o enviada com sucesso!" });
          });
        });
      };

      document.getElementById("btn-logout").addEventListener("click", () => {
        firebase.auth().signOut().then(() => {
          window.location.href = "login.html";
        });
      });
    });
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=SUA_API_KEY&libraries=places"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
