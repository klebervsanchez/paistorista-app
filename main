const firebaseConfig = {
  apiKey: "AIzaSyCT9QQ9-AUvngXp0c_7l9yQXpDk1seAgmw",
  authDomain: "paistorista-57706.firebaseapp.com",
  databaseURL: "https://paistorista-57706-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Protege a tela: só mostra se estiver logado
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    console.log("Usuário logado:", user.displayName);
  }
});

// Logout
document.getElementById("logout-button").addEventListener("click", () => {
  auth.signOut().then(() => window.location.href = "login.html");
});

// MAPA
let mapa;
function initMap() {
  mapa = new google.maps.Map(document.getElementById("mapa"), {
    center: { lat: -23.55052, lng: -46.633308 },
    zoom: 12
  });
}

// GEOLOCALIZAÇÃO
document.getElementById('localizacao-btn').addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const latlng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
    new google.maps.Geocoder().geocode({ location: latlng }, (res, status) => {
      if (status === 'OK' && res[0]) {
        document.getElementById('origem').value = res[0].formatted_address;
      }
    });
  });
});

// TRAÇAR ROTA
document.getElementById('tracar-rota').addEventListener('click', () => {
  const origem = document.getElementById('origem').value;
  const destino = document.getElementById('destino').value;

  const service = new google.maps.DirectionsService();
  const renderer = new google.maps.DirectionsRenderer();
  renderer.setMap(mapa);

  service.route({
    origin: origem,
    destination: destino,
    travelMode: 'DRIVING'
  }, (result, status) => {
    if (status === 'OK') {
      renderer.setDirections(result);
    } else {
      alert("Erro ao traçar rota: " + status);
    }
  });
});

// SALVAR ROTA
document.getElementById('salvar-rota').addEventListener('click', () => {
  const rota = {
    origem: document.getElementById('origem').value,
    destino: document.getElementById('destino').value,
    horario: document.getElementById('horario').value,
    usuario: auth.currentUser.displayName
  };
  db.ref('rotas').push(rota);
  alert("Rota salva!");
});

// CHAT
document.getElementById('chat-enviar').addEventListener('click', () => {
  const mensagem = document.getElementById('chat-input').value.trim();
  if (!mensagem) return;
  db.ref('mensagens').push({
    nome: auth.currentUser.displayName,
    msg: mensagem
  });
  document.getElementById('chat-input').value = '';
});

db.ref('mensagens').on('child_added', snap => {
  const { nome, msg } = snap.val();
  const div = document.createElement('div');
  div.textContent = `${nome}: ${msg}`;
  document.getElementById('chat-mensagens').appendChild(div);
});
