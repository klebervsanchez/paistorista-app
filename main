// CONFIGURAÇÃO DO FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCT9QQ9-AUvngXp0c_7l9yQXpDk1seAgmw",
  authDomain: "paistorista-57706.firebaseapp.com",
  databaseURL: "https://paistorista-57706-default-rtdb.firebaseio.com",
  projectId: "paistorista-57706",
  storageBucket: "paistorista-57706.appspot.com",
  messagingSenderId: "993847153120",
  appId: "1:993847153120:web:adc3ed34c0a8791c3485f5"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const loginContainer = document.getElementById('login-container');
const appContainer = document.getElementById('app-container');

// LOGIN
document.getElementById('login-button').addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    alert("Erro no login: " + err.message);
  });
});

// DETECTAR LOGIN AUTOMATICAMENTE
auth.onAuthStateChanged(user => {
  if (user) {
    loginContainer.style.display = 'none';
    appContainer.classList.remove('hidden');
    initMap();
  } else {
    loginContainer.style.display = 'block';
    appContainer.classList.add('hidden');
  }
});

// MAPA
let mapa;
function initMap() {
  mapa = new google.maps.Map(document.getElementById("mapa"), {
    center: { lat: -23.55052, lng: -46.633308 },
    zoom: 12
  });
}

// GEOLOCALIZAÇÃO
document.getElementById('localizacao-btn').addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const latlng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
    new google.maps.Geocoder().geocode({ location: latlng }, (res, status) => {
      if (status === 'OK' && res[0]) {
        document.getElementById('origem').value = res[0].formatted_address;
      }
    });
  });
});

// TRAÇAR ROTA
document.getElementById('tracar-rota').addEventListener('click', () => {
  const origem = document.getElementById('origem').value;
  const destino = document.getElementById('destino').value;

  const service = new google.maps.DirectionsService();
  const renderer = new google.maps.DirectionsRenderer();
  renderer.setMap(mapa);

  service.route({
    origin: origem,
    destination: destino,
    travelMode: 'DRIVING'
  }, (result, status) => {
    if (status === 'OK') {
      renderer.setDirections(result);
    } else {
      alert("Erro ao traçar rota: " + status);
    }
  });
});

// SALVAR ROTA
document.getElementById('salvar-rota').addEventListener('click', () => {
  const rota = {
    origem: document.getElementById('origem').value,
    destino: document.getElementById('destino').value,
    horario: document.getElementById('horario').value,
    usuario: auth.currentUser.displayName
  };
  db.ref('rotas').push(rota);
  alert("Rota salva!");
});

// CHAT
document.getElementById('chat-enviar').addEventListener('click', () => {
  const mensagem = document.getElementById('chat-input').value.trim();
  if (!mensagem) return;
  db.ref('mensagens').push({
    nome: auth.currentUser.displayName,
    msg: mensagem
  });
  document.getElementById('chat-input').value = '';
});

db.ref('mensagens').on('child_added', snap => {
  const { nome, msg } = snap.val();
  const div = document.createElement('div');
  div.textContent = `${nome}: ${msg}`;
  document.getElementById('chat-mensagens').appendChild(div);
});
